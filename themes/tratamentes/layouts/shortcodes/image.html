<!-- Sistema de Imagens Otimizadas - TrataMentes -->

<!-- Shortcode para imagens responsivas com WebP -->
{{ $src := .Get "src" }}
{{ $alt := .Get "alt" | default "Imagem TrataMentes" }}
{{ $class := .Get "class" | default "" }}
{{ $width := .Get "width" | default "800" }}
{{ $height := .Get "height" | default "600" }}
{{ $loading := .Get "loading" | default "lazy" }}
{{ $placeholder := .Get "placeholder" | default "true" }}

<figure class="image-container {{ $class }}" 
        style="aspect-ratio: {{ $width }}/{{ $height }};">
    
    <!-- Placeholder enquanto carrega -->
    {{ if eq $placeholder "true" }}
    <div class="image-placeholder" aria-hidden="true">
        <div class="placeholder-content">
            <svg width="60" height="60" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M21 19V5C21 3.9 20.1 3 19 3H5C3.9 3 3 3.9 3 5V19C3 20.1 3.9 21 5 21H19C20.1 21 21 20.1 21 19ZM8.5 13.5L11 16.51L14.5 12L19 18H5L8.5 13.5Z" fill="#ccc"/>
            </svg>
            <span class="sr-only">A carregar imagem...</span>
        </div>
    </div>
    {{ end }}
    
    <!-- Imagem principal com suporte WebP -->
    <picture class="responsive-image">
        <!-- WebP para browsers modernos -->
        <source srcset="/images/webp/{{ $src }}.webp" type="image/webp">
        
        <!-- Fallback para browsers antigos -->
        <img src="/images/{{ $src }}" 
             alt="{{ $alt }}"
             width="{{ $width }}"
             height="{{ $height }}"
             loading="{{ $loading }}"
             class="main-image"
             onload="this.parentElement.parentElement.classList.add('loaded')"
             onerror="this.parentElement.parentElement.classList.add('error')">
    </picture>
    
    <!-- Caption opcional -->
    {{ if .Get "caption" }}
    <figcaption class="image-caption">
        {{ .Get "caption" }}
    </figcaption>
    {{ end }}
</figure>

<!-- CSS para Sistema de Imagens -->
<style>
/* Container da imagem */
.image-container {
    position: relative;
    overflow: hidden;
    border-radius: 8px;
    background-color: #f8f9fa;
    margin: 1rem 0;
    transition: all 0.3s ease;
}

/* Placeholder */
.image-placeholder {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(45deg, #f0f0f0 25%, transparent 25%), 
                linear-gradient(-45deg, #f0f0f0 25%, transparent 25%), 
                linear-gradient(45deg, transparent 75%, #f0f0f0 75%), 
                linear-gradient(-45deg, transparent 75%, #f0f0f0 75%);
    background-size: 20px 20px;
    background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
    animation: placeholderShimmer 2s infinite linear;
    z-index: 1;
}

.placeholder-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    opacity: 0.6;
}

@keyframes placeholderShimmer {
    0% { background-position: 0 0, 0 10px, 10px -10px, -10px 0px; }
    100% { background-position: 20px 20px, 20px 30px, 30px 10px, 10px 20px; }
}

/* Imagem responsiva */
.responsive-image {
    display: block;
    width: 100%;
    height: 100%;
    position: relative;
    z-index: 2;
}

.main-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: center;
    transition: opacity 0.3s ease, transform 0.3s ease;
    opacity: 0;
}

/* Estados da imagem */
.image-container.loaded .main-image {
    opacity: 1;
}

.image-container.loaded .image-placeholder {
    opacity: 0;
    pointer-events: none;
}

.image-container.error .image-placeholder {
    background: #f8d7da;
    color: #721c24;
}

.image-container.error .placeholder-content::after {
    content: "Erro ao carregar imagem";
    font-size: 0.875rem;
    margin-top: 0.5rem;
}

/* Hover effects */
.image-container:hover .main-image {
    transform: scale(1.02);
}

/* Caption */
.image-caption {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(transparent, rgba(0, 0, 0, 0.7));
    color: white;
    padding: 2rem 1rem 1rem;
    font-size: 0.875rem;
    line-height: 1.4;
    z-index: 3;
}

/* Variações de tamanho */
.image-container.small {
    max-width: 300px;
}

.image-container.medium {
    max-width: 600px;
}

.image-container.large {
    max-width: 1200px;
}

.image-container.full-width {
    width: 100%;
    max-width: none;
}

/* Variações de formato */
.image-container.square {
    aspect-ratio: 1/1;
}

.image-container.portrait {
    aspect-ratio: 3/4;
}

.image-container.landscape {
    aspect-ratio: 16/9;
}

.image-container.wide {
    aspect-ratio: 21/9;
}

/* Galeria de imagens */
.image-gallery {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
    margin: 2rem 0;
}

.image-gallery .image-container {
    margin: 0;
    cursor: pointer;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.image-gallery .image-container:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
}

/* Lightbox simples */
.lightbox {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.9);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    padding: 2rem;
}

.lightbox.active {
    display: flex;
}

.lightbox-content {
    max-width: 90vw;
    max-height: 90vh;
    position: relative;
}

.lightbox-image {
    width: 100%;
    height: 100%;
    object-fit: contain;
}

.lightbox-close {
    position: absolute;
    top: -40px;
    right: 0;
    background: none;
    border: none;
    color: white;
    font-size: 2rem;
    cursor: pointer;
    padding: 0.5rem;
}

/* Responsividade */
@media (max-width: 768px) {
    .image-gallery {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 0.5rem;
    }
    
    .image-caption {
        font-size: 0.75rem;
        padding: 1.5rem 0.75rem 0.75rem;
    }
    
    .lightbox {
        padding: 1rem;
    }
}

/* Performance optimizations */
@media (prefers-reduced-motion: reduce) {
    .image-container,
    .main-image,
    .image-placeholder {
        animation: none;
        transition: none;
    }
}

/* Print styles */
@media print {
    .image-placeholder {
        display: none;
    }
    
    .main-image {
        opacity: 1;
    }
}
</style>

<!-- JavaScript para Sistema de Imagens -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Lazy loading fallback para browsers antigos
    if (!('loading' in HTMLImageElement.prototype)) {
        const images = document.querySelectorAll('img[loading="lazy"]');
        const imageObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    img.src = img.dataset.src || img.src;
                    img.classList.remove('lazy');
                    imageObserver.unobserve(img);
                }
            });
        });
        
        images.forEach(img => imageObserver.observe(img));
    }
    
    // Lightbox functionality
    function initLightbox() {
        // Criar lightbox se não existir
        let lightbox = document.getElementById('lightbox');
        if (!lightbox) {
            lightbox = document.createElement('div');
            lightbox.id = 'lightbox';
            lightbox.className = 'lightbox';
            lightbox.innerHTML = `
                <div class="lightbox-content">
                    <button class="lightbox-close" aria-label="Fechar">&times;</button>
                    <img class="lightbox-image" src="" alt="">
                </div>
            `;
            document.body.appendChild(lightbox);
        }
        
        const lightboxImage = lightbox.querySelector('.lightbox-image');
        const closeBtn = lightbox.querySelector('.lightbox-close');
        
        // Event listeners
        closeBtn.addEventListener('click', closeLightbox);
        lightbox.addEventListener('click', (e) => {
            if (e.target === lightbox) closeLightbox();
        });
        
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeLightbox();
        });
        
        // Adicionar clique às imagens da galeria
        document.querySelectorAll('.image-gallery .image-container').forEach(container => {
            container.addEventListener('click', function() {
                const img = this.querySelector('.main-image');
                if (img && img.src) {
                    lightboxImage.src = img.src;
                    lightboxImage.alt = img.alt;
                    lightbox.classList.add('active');
                    document.body.style.overflow = 'hidden';
                    
                    // Track lightbox open
                    if (typeof trackEvent === 'function') {
                        trackEvent('lightbox_open', {
                            category: 'engagement',
                            action: 'image_lightbox_open'
                        });
                    }
                }
            });
        });
        
        function closeLightbox() {
            lightbox.classList.remove('active');
            document.body.style.overflow = '';
            lightboxImage.src = '';
        }
    }
    
    // Inicializar lightbox
    initLightbox();
    
    // Preload de imagens críticas
    function preloadCriticalImages() {
        const criticalImages = document.querySelectorAll('.image-container.critical img');
        criticalImages.forEach(img => {
            const link = document.createElement('link');
            link.rel = 'preload';
            link.as = 'image';
            link.href = img.src;
            document.head.appendChild(link);
        });
    }
    
    preloadCriticalImages();
    
    // Monitor de performance de imagens
    function monitorImagePerformance() {
        const images = document.querySelectorAll('.main-image');
        images.forEach(img => {
            const startTime = performance.now();
            
            img.addEventListener('load', function() {
                const loadTime = performance.now() - startTime;
                
                // Track slow loading images
                if (loadTime > 3000 && typeof trackEvent === 'function') {
                    trackEvent('slow_image_load', {
                        category: 'performance',
                        action: 'image_load_slow',
                        value: Math.round(loadTime),
                        label: this.src
                    });
                }
            });
            
            img.addEventListener('error', function() {
                // Track image errors
                if (typeof trackEvent === 'function') {
                    trackEvent('image_load_error', {
                        category: 'error',
                        action: 'image_load_failed',
                        label: this.src
                    });
                }
            });
        });
    }
    
    monitorImagePerformance();
});

// Função para converter imagens para WebP (para uso futuro)
function convertToWebP(canvas, quality = 0.8) {
    return new Promise((resolve) => {
        canvas.toBlob(resolve, 'image/webp', quality);
    });
}

// Função para redimensionar imagens
function resizeImage(file, maxWidth = 1200, maxHeight = 800, quality = 0.8) {
    return new Promise((resolve) => {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const img = new Image();
        
        img.onload = function() {
            // Calcular novas dimensões
            let { width, height } = img;
            
            if (width > height) {
                if (width > maxWidth) {
                    height = (height * maxWidth) / width;
                    width = maxWidth;
                }
            } else {
                if (height > maxHeight) {
                    width = (width * maxHeight) / height;
                    height = maxHeight;
                }
            }
            
            canvas.width = width;
            canvas.height = height;
            
            // Desenhar imagem redimensionada
            ctx.drawImage(img, 0, 0, width, height);
            
            // Converter para blob
            canvas.toBlob(resolve, 'image/jpeg', quality);
        };
        
        img.src = URL.createObjectURL(file);
    });
}
</script>

<!-- Instruções de Uso -->
<!--
COMO USAR O SISTEMA DE IMAGENS:

1. Estrutura de pastas recomendada:
   /static/images/
   ├── webp/          (versões WebP otimizadas)
   ├── hero/          (imagens do hero)
   ├── services/      (imagens dos serviços)
   ├── team/          (fotos da equipa)
   ├── gallery/       (galeria de fotos)
   └── icons/         (ícones e logos)

2. No conteúdo Hugo, use:
   {{< image src="hero/massage-therapy" alt="Massagem terapêutica" width="1200" height="600" class="large landscape" >}}

3. Para galerias:
   <div class="image-gallery">
     {{< image src="gallery/treatment1" alt="Tratamento 1" class="square" >}}
     {{< image src="gallery/treatment2" alt="Tratamento 2" class="square" >}}
   </div>

4. Otimização de imagens:
   - Use ferramentas como ImageOptim, TinyPNG
   - Gere versões WebP com: cwebp input.jpg -q 80 -o output.webp
   - Mantenha originais em JPEG/PNG como fallback

5. Tamanhos recomendados:
   - Hero: 1920x1080 (WebP ~200KB)
   - Serviços: 800x600 (WebP ~100KB)
   - Galeria: 600x600 (WebP ~80KB)
   - Thumbnails: 300x300 (WebP ~30KB)

6. Classes disponíveis:
   - Tamanho: small, medium, large, full-width
   - Formato: square, portrait, landscape, wide
   - Especiais: critical (preload), gallery (lightbox)
-->

